Draft Manual for ESP-909
Simple operating guide 
Slider2732 - September 2021


Contents
--------
Play It!
Pattern Copy
Pattern Chain
Tempo
Swing (shuffle)
Metronome
MIDI
Construction notes
Practical Workflow
Adding your own samples




Play It!
--------
When the USB cable is connected to the ESP8266, the unit powers up into Live Play mode.
Live Play mode is denoted by the LED being constantly lit. 
Press any drum button to hear each sound, practice patterns, add a live layer to a pre-recorded track etc.
When in this mode, the Function button on the right side end of the drum buttons becomes very powerful.
Press button 1 (Bass Drum) along with Function to execute Pattern Copy.
Press button 2 (Snare) along with Function to execute Pattern Chain.
Press button 3 (Low Tom) along with Function to enter Tap Tempo mode.
Press button 4 along with Function to switch on the metronome.
Press button 5 along with Function to switch off the metronome.
More features are intended to be added.
When ready to record, press the Record/Live mode button.
Tempo can be set with the relevant pot, BPM indication is with a flash of the LED on positions 1, 9 and 11 of the 16 part pattern.
Tempo can also be set with the Tap Tempo feature detailed below.
Each drum sound will be quantized to 1/16th of the pattern.
If unhappy with a sound, press the same button again to remove it (easiest if the tempo is temporarily lowered).
Variations in swing (shuffle) can be made by using the Swing pot.
To swap to pattern 2, press the Function button while pattern 1 is playing. 
To return to Live mode, press the Record/Live mode button at any time. 
To pause playback of a pattern at the pattern end beat, press the Pause/Play button. The pattern will stop at the end of its 16 note sequence and will restart the instant the button is released.
To reset the drum machine, press the Reset button.


Pattern Copy
------------
Change the mode to Live play mode, by pressing the mode button (attached to C14 of the multiplexer).
Press button 1 (Bass Drum) along with Function.
Pattern 1 will be copied to pattern 2.
The LED will flash a sequence and a sound will be heard.
Returning to Record mode using the Record mode button will result in both patterns sounding the same. Changes to patterns 1 or 2 can be made in the same regular way. Pattern copy allows for a variation on pattern 2, or, as a backup of pattern 1.  


Pattern Chain
-------------
Change the mode to Live play mode, by pressing the mode button (attached to C14 of the multiplexer).
Press button 2 (Snare Drum) along with Function.
Pattern 2 will be added to the end of pattern 1.
The pattern length of the sequence will now be 32 beats. 
The LED will remain off for a second while performing the chain and then a sound will be heard. The LED behaves in this way, to confirm to the player that he/she has pressed the correct button. 
Returning to Record mode using the Record mode button will result in the full 32 steps being played.
N.B. Pressing the Function button to swap to pattern 2 results in no action.  


Tempo
-----
Tempo can be changed by using the Tempo pot.
The range is approximately 40 BPM to 300 BPM.
Indication of the tempo is given by the LED, with flashes on pattern positions 1,9 and 11.  


Tap Tempo
---------
Tempo can also be changed by using the Tap Tempo feature.
Change the mode to Live play mode, by pressing the mode button (attached to C14 of the multiplexer).
The range of BPM is 40 BPM up to however fast you can tap the relevant key/button!
Press key/button 3 and then the Function button.
The timer will count to 10seconds, during which time you should tap to the beat required for the BPM.
The drum machine will then enter Play mode, where you will be able to see (and hear if beats are already present) the BPM.


Swing
-----
Swing, or shuffle, at this early stage of development is a simple measurement of the swing pot position, divided down. 
Each second beat is delayed by the swing amount, with the remaining beat time length shortened after the drum sound is fired. 
The code will be updated to Roger Linn's % method.
For now, it allows useful timing variations and experimentation with pattern structures, creating a different feel to played patterns.   


Metronome
---------
The metronome can be switched off and on, by pressing the Run/Live mode button.
Then, drum key 4 and Function at the same time to switch it on. 
Or, drum key 5 and Function at the same time to switch it off.
The tempo LED will go off for 1/2 second, signifying the change.
N.B. Switching on and off will affect both patterns. 
The metronome is off by default.


MIDI
----
MIDI In and Out are implemented, but so far only MIDI Out is working.
Jan Ostman's initial codebase for ESP-909 includes MIDI functionality and somewhere along development I may have borked it!
This manual will be updated when it's fixed. It may work for you as it stands, my MIDI circuit is homemade from salvaged components. 
MIDI commands in both directions will be Start/Stop, Pause and Note data. 
At the moemnt, those commands work on pin D4 for MIDI Out.
There is also the ability to change the PPQN, if a slave device uses a different amount than 24.
Press drum key 6 and Function to step through various PPQN amounts. 






Construction Notes
------------------
With reference to the prototype build picture on Github. 

Components required -
Wemos D1 Mini (ESP8266)
HC4067 16 port multiplexer
15 momentary action buttons
2x 5K pot
MIDI circuit (Sparkfun/Adafruit etc, or homemade)
100uF 16V capacitor
1nF (103) ceramic capacitor
1x LED, with 100 ohm resistor to protect it
2 pin connector 
Large perfboard (12cm x 18cm)

The layout is up to you, here is how the prototype circuit is arranged -
Top left is the Wemos D1 Mini, underneath the board. 
Output audio is from the RX pin, the audio filter consisting of 100uF electrolytic cap and 1nf ceramic cap are connected to it. A 2 pin header connector is a simple way to enable or disable the RX pin for code uploads. 
Top middle is the MIDI circuit. 
Top right is the Reset button, connected to GND and RST on the Wemos D1 Mini.
Middle left are the Tempo pot (5K), LED, Swing pot (5K) and an unused pot, perhaps for reverb or pitch later in development.  
Middle right are the Record/Live mode button and Play/Pause button.
Bottom row is for the drum sounds, 1 button per sound, matching the placement of the TR-909 drum sounds. 
Bottom row right, is the Function button.
Due to the multiplexer having capacitance properties, you may find that low hight buttons will trigger another sound as well. The fix, is to use taller buttons, increase spacings, or, use PC key switches and caps. The prototype build was found to suffer from the issue, buttons being replaced by ALPS key switches from a late 1980's busted laptop. 


A look through the code will determine the correct connections. 
The code has been commented with hopefully useful information. 

Here is a reference guide to those connections - 

 Wemos D1 Mini pins:
 D0 - Play/Pause
 D1 - S3
 D2 - S2
 D3 - Tempo LED
 D4 - MIDI Out
 D5 - S0
 D6 - S1
 D7 - (RX MIDI)
 D8 - (TX MIDI)
 A0 - Input from multiplexer

 16 channel Multiplexer
 ports 0 - 10 drum sounds buttons
 port[11] Pattern swap button
 port[12] Swing amount pot
 port[13] Unused pot
 port[14] Record/Live button
 port[15] Tempo pot



Practical Workflow
------------------
It may be dauntingn to use something like this project for the first time. Here is my own workflow, whch may be of help.
Turn on the ESP-909.
A sound will be heard (allowing a check of audio hardware).
Then, if MIDI is connected, a short run of notes will be heard on the receiving device (allowing a check of the MIDI connection). 
The ESP-909 is now in Live mode, where several functions are available. 
I tend to press drum key 4 then Function at the same time to switch on the metronome. The LED turns off then back on to signify the change. 
Press the Run/Live mode button and beats can be put in their correct places by following the metronome sound. The tempo can also be adjusted,at any time with the tempo pot. 
Swap to pattern 2 by pressing the Function key and enter some drum sounds.  
Press Run/Live again and then drum key 5 and Function, to turn off the metronome. 
The rest of the parts of the pattern(s) are then added. 
The pattern is recorded to a Zoom R8 8 track recorder, along with anything connected to MIDI.
Fills and extra drums can be added on a separate track, or during mixdown to the Master track of the Zoom R8.
Quick, logical and effective is the aim.   



Adding your own samples
-----------------------
A source of many problems, because most examples found online will apply to 8 bit samples. 
The project uses 16 bit, 44.1kHz samples.

Here is how to manage your own sounds -
Firstly, find samples that you would like to use, many places have free downloads of the classic machines. 
If you have a modern Apple device, iTunes will apparently take care of sample conversion to C++.
For windows users, there are programs such as Wav2c.

For Linux Mint, this command works really well: od -s  --address-radix=none Kick.wav
Where Kick.wav is the sample you would like to see. 
When used in the Terminal, within the directory where samples are located, the line will show the wav file's contents.
Copy and paste the output to a text editor.
Delete the directory information and the first 44 bytes of data (wav's contain text information at the start).
Replace the spaces,with a search and replace of spaces, to ',' commas. I find it best to tap 5 spaces in the search, press 'Replace All', delete a space and repeat.
The file should now contain numbers such as 23187, -11859, 14453, 13673.
Make a mental note of the file size in Words, most editors have the feature. 
Copy the altered text file to the relevant drum sound in Drums.h and replace the bytes total before PROGMEM with the number shown as Words in the text editor.  
Lastly, change the drum bytes total at the top of Drums.h, example - BD16LEN = 4987UL may become BD16LEN = 5489UL
All done. The replaced drum is ready to be tried. 
